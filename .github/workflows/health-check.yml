name: 24x7 Health Check - Automated Monitoring

on:
  schedule:
    # Run every 30 minutes
    - cron: '*/30 * * * *'
  
  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      defects_enabled:
        description: 'Enable defect injection'
        required: false
        default: 'true'

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      issues: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install Chrome and ChromeDriver
      run: |
        sudo apt-get update
        sudo apt-get install -y chromium-browser chromium-browser-l10n
        sudo apt-get install -y chromium-chromedriver
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install selenium requests openpyxl pyyaml
        
        # Download ChromeDriver
        pip install webdriver-manager
    
    - name: Run health checks (Selenium)
      run: |
        set -e  # Exit on error
        python axis3_enhanced.py
        echo "Selenium completed successfully"
        ls -la raw_alerts.json 2>&1 || echo "WARNING: raw_alerts.json not found"
      env:
        DEFECTS_ENABLED: ${{ github.event.inputs.defects_enabled || 'true' }}
        EXECUTION_ID: ${{ github.run_id }}_${{ github.run_number }}
      continue-on-error: true
    
    - name: Debug - Check generated files
      run: |
        echo "Files in project:"
        ls -la *.json *.xlsx 2>/dev/null || echo "No files found"
        echo ""
        echo "Alert database content:"
        cat alert_database.json 2>/dev/null | head -20 || echo "No alert_database.json"
    
    - name: Process alerts (Alert Engine)
      run: python process_alerts.py
      env:
        EXECUTION_ID: ${{ github.run_id }}_${{ github.run_number }}
    
    - name: Create GitHub tickets
      run: python create_tickets.py
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPO_OWNER: ${{ github.repository_owner }}
        GITHUB_REPO_NAME: ${{ github.event.repository.name }}
    
    - name: Send Slack notifications
      run: python send_slack_notifications.py
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      continue-on-error: true
    
    - name: Generate reports
      run: python generate_reports.py
      env:
        EXECUTION_ID: ${{ github.run_id }}_${{ github.run_number }}
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: health-check-report-${{ github.run_id }}
        path: |
          link_check_report.xlsx
          alert_report.json
          ticket_summary.json
    
    - name: Slack notification - Job Status
      if: always()
      run: |
        if [ "${{ secrets.SLACK_WEBHOOK_URL }}" != "" ]; then
          python send_slack_notifications.py
        fi
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      continue-on-error: true

  # Send daily summary email
  send-email-digest:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    needs: health-check
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install pyyaml
    
    - name: Send daily email digest
      run: python send_daily_email.py
      env:
        EMAIL_USER: ${{ secrets.EMAIL_USER }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
      continue-on-error: true

  # Dashboard update job (disabled - kept for reference)
  # update-dashboard:
  #   runs-on: ubuntu-latest
  #   if: always()
  #   needs: health-check
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v3
  #     - name: Update dashboard data
  #       run: echo "Dashboard data would be updated here"

# Scheduled cleanup job (disabled - kept for reference)
# cleanup:
#   runs-on: ubuntu-latest
#   if: github.event_name == 'schedule'
#   steps:
#     - name: Checkout code
#       uses: actions/checkout@v3
#     - name: Set up Python
#       uses: actions/setup-python@v4
#       with:
#         python-version: '3.9'
#     - name: Clean up old artifacts
#       run: echo "Cleanup would run here"
